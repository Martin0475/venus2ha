<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLE ? MQTT PWA</title>
<script src="paho-mqtt.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
input, button { margin: 5px 0; padding: 5px; width: 100%; }
#log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
</style>
</head>
<body>
<h2>BLE 2 MQTT</h2>

<h3>MQTT-Verbindung</h3>
<input id="mqttIp" placeholder="MQTT IP">
<input id="mqttPort" placeholder="Port (z.B. 1884)">
<input id="mqttUser" placeholder="Benutzername">
<input id="mqttPass" placeholder="Passwort">
<button onclick="connectMQTT()">Verbinde MQTT</button>

<h3>BLE-Geräte</h3>
<button onclick="scanBLE()">Scan starten</button>
<ul id="bleDevices"></ul>

<h3>Log</h3>
<div id="log"></div>

<script>
let mqttClient;
let bleDevice;
let bleServer;
let txCharacteristic, rxCharacteristic;

function log(msg){
    let logDiv = document.getElementById("log");
    logDiv.innerHTML += msg + "<br>";
    logDiv.scrollTop = logDiv.scrollHeight;
}

// --- Hilfsfunktionen Hex ↔ Bytes ---
function hexToBytes(hex) {
    hex = hex.replace(/\s+/g, '');
    let bytes = new Uint8Array(hex.length / 2);
    for(let i = 0; i < hex.length; i += 2){
        bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
    }
    return bytes;
}

function bytesToHex(buffer) {
    return [...new Uint8Array(buffer)]
        .map(b => b.toString(16).padStart(2, '0').toUpperCase())
        .join(' ');
}

// --- MQTT ---
function connectMQTT() {
    let host = document.getElementById("mqttIp").value;
    let port = parseInt(document.getElementById("mqttPort").value);
    let user = document.getElementById("mqttUser").value;
    let pass = document.getElementById("mqttPass").value;

    mqttClient = new Paho.Client(host, port, "ble-client-" + Date.now());

    mqttClient.onConnectionLost = (responseObject) => {
        log("MQTT Verbindung verloren: " + responseObject.errorMessage);
    };

    mqttClient.onMessageArrived = (message) => {
        let payload = message.payloadString;
        log("MQTT empfangen: " + message.destinationName + " -> " + payload);
        // Auf Write-Topic lauschen und an BLE weiterleiten
        if(message.destinationName === "martin0475/ble2mqtt/write") {
            if(txCharacteristic){
                log("→ Weitergeleitet an BLE (Hex)");
                sendBLEHex(payload);
            } else {
                log("→ Keine BLE-Verbindung, Nachricht verworfen");
            }
        }
    };

    mqttClient.connect({
        userName: user,
        password: pass,
        useSSL: false,
        mqttVersion: 4,
        onSuccess: () => {
            log("MQTT verbunden");
            mqttClient.subscribe("martin0475/ble2mqtt/write");
            log("Subscribed auf: martin0475/ble2mqtt/write");
        },
        onFailure: (err) => log("MQTT Fehler: " + JSON.stringify(err))
    });
}

function sendMQTT(topic, payload){
    if(!mqttClient || !mqttClient.isConnected()) {
        log("MQTT nicht verbunden");
        return;
    }
    let message = new Paho.Message(payload);
    message.destinationName = topic;
    mqttClient.send(message);
    log("→ MQTT gesendet: " + topic + " -> " + payload);
}

// --- BLE ---
async function scanBLE(){
    try {
        let device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ["0000ff00-0000-1000-8000-00805f9b34fb"]
        });
        log("Gerät gefunden: " + device.name);
        document.getElementById("bleDevices").innerHTML += `<li>${device.name}</li>`;
        bleDevice = device;

        bleDevice.addEventListener('gattserverdisconnected', () => {
            log("BLE getrennt: " + bleDevice.name);
        });

        bleServer = await bleDevice.gatt.connect();
        const service = await bleServer.getPrimaryService("0000ff00-0000-1000-8000-00805f9b34fb");
        txCharacteristic = await service.getCharacteristic("0000ff01-0000-1000-8000-00805f9b34fb");
        rxCharacteristic = await service.getCharacteristic("0000ff02-0000-1000-8000-00805f9b34fb");

        await rxCharacteristic.startNotifications();
        rxCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
            let hex = bytesToHex(event.target.value.buffer);
            log("BLE empfangen (Hex): " + hex);
            sendMQTT("martin0475/ble2mqtt/read", hex);
            log("→ Weitergeleitet an MQTT Read-Topic");
        });

        log("BLE verbunden und Notifications aktiviert");

    } catch (error) {
        log("BLE Fehler: " + error);
    }
}

// --- BLE schreiben (Hex, aufgerufen von MQTT Write-Topic) ---
async function sendBLEHex(hexString){
    if(!txCharacteristic) { log("Keine BLE Verbindung"); return; }
    let data = hexToBytes(hexString);
    await txCharacteristic.writeValueWithoutResponse(data);
    log("BLE gesendet (Hex): " + hexString);
}
</script>

</body>
</html>
