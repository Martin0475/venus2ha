<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLE2MQTT PWA</title>
<script src="paho-mqtt.js"></script>
</head>
<body>
<h2>BLE2MQTT</h2>

<div>
    <label>MQTT Broker IP: <input type="text" id="mqtt-ip" value="192.168.1.100"></label><br>
    <label>Port: <input type="text" id="mqtt-port" value="1884"></label><br>
    <label>Username: <input type="text" id="mqtt-user"></label><br>
    <label>Password: <input type="password" id="mqtt-pass"></label><br>
    <button id="connect-mqtt">Verbinde MQTT</button>
</div>

<div>
    <button id="scan-ble">BLE Ger√§t scannen</button>
    <p id="ble-status"></p>
</div>

<script>
let mqttClient;
let bleDevice;
let txCharacteristic;
let rxCharacteristic;

// ------------------ MQTT ------------------
document.getElementById("connect-mqtt").addEventListener("click", () => {
    const host = document.getElementById("mqtt-ip").value;
    const port = parseInt(document.getElementById("mqtt-port").value);
    const user = document.getElementById("mqtt-user").value;
    const pass = document.getElementById("mqtt-pass").value;

    mqttClient = new Paho.MQTT.Client(host, port, "ble2mqtt_" + Math.random().toString(16).substr(2, 8));
    mqttClient.onConnectionLost = e => console.log("MQTT verloren", e);
    mqttClient.onMessageArrived = e => {
        if(txCharacteristic){
            txCharacteristic.writeValue(new TextEncoder().encode(e.payloadString))
            .catch(err => console.error("BLE write error:", err));
        }
    };

    mqttClient.connect({
        userName: user,
        password: pass,
        onSuccess: () => console.log("MQTT verbunden"),
        onFailure: err => console.error("MQTT Fehler", err)
    });
});

// ------------------ BLE ------------------
document.getElementById("scan-ble").addEventListener("click", async () => {
    try {
        bleDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['0000ff00-0000-1000-8000-00805f9b34fb']
        });
        document.getElementById("ble-status").textContent = `Verbinde mit ${bleDevice.name || bleDevice.id}...`;

        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService('0000ff00-0000-1000-8000-00805f9b34fb');

        txCharacteristic = await service.getCharacteristic('0000ff01-0000-1000-8000-00805f9b34fb');
        rxCharacteristic = await service.getCharacteristic('0000ff02-0000-1000-8000-00805f9b34fb');

        await rxCharacteristic.startNotifications();
        rxCharacteristic.addEventListener('characteristicvaluechanged', e => {
            const value = new TextDecoder().decode(e.target.value);
            console.log("BLE RX:", value);
            if(mqttClient && mqttClient.isConnected()){
                mqttClient.publish("martin0475/ble2mqtt/read", value);
            }
        });

        document.getElementById("ble-status").textContent = `Verbunden mit ${bleDevice.name || bleDevice.id}`;
    } catch(err){
        console.error("BLE Fehler:", err);
        document.getElementById("ble-status").textContent = "BLE Verbindung fehlgeschlagen: " + err;
    }
});
</script>
</body>
</html>
